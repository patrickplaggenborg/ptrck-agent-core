{
  "description": "|",
  "metadata": {
    "license": "MIT"
  },
  "references": {
    "files": [
      "references/mcp-servers-guide.md",
      "references/permissions-guide.md",
      "references/query-api-reference.md",
      "references/session-management.md",
      "references/subagents-patterns.md",
      "references/top-errors.md"
    ]
  },
  "content": "**Status**: Production Ready\r\n**Last Updated**: 2025-10-25\r\n**Dependencies**: @anthropic-ai/claude-agent-sdk, zod\r\n**Latest Versions**: @anthropic-ai/claude-agent-sdk@0.1.0+, zod@3.23.0+\r\n\r\n---",
  "name": "claude-agent-sdk",
  "id": "claude-agent-sdk",
  "sections": {
    "Table of Contents": "1. [Core Query API](#core-query-api)\r\n2. [Tool Integration](#tool-integration-built-in--custom)\r\n3. [MCP Servers](#mcp-servers-model-context-protocol)\r\n4. [Subagent Orchestration](#subagent-orchestration)\r\n5. [Session Management](#session-management)\r\n6. [Permission Control](#permission-control)\r\n7. [Filesystem Settings](#filesystem-settings)\r\n8. [Message Types & Streaming](#message-types--streaming)\r\n9. [Error Handling](#error-handling)\r\n10. [Known Issues](#known-issues-prevention)\r\n\r\n---",
    "Production Examples": "This skill is based on official Anthropic documentation and SDK patterns:\r\n- **Documentation**: https://docs.claude.com/en/api/agent-sdk/\r\n- **Validation**: ✅ All patterns tested with SDK 0.1.0+\r\n- **Use Cases**: Coding agents, SRE systems, security auditors, CI/CD automation\r\n- **Platform Support**: Node.js 18+, TypeScript 5.3+\r\n\r\n---",
    "Quick Start (5 Minutes)": "### 1. Install SDK\r\n\r\n```bash\r\nnpm install @anthropic-ai/claude-agent-sdk zod\r\n```\r\n\r\n**Why these packages:**\r\n- `@anthropic-ai/claude-agent-sdk` - Main Agent SDK\r\n- `zod` - Type-safe schema validation for tools\r\n\r\n### 2. Set API Key\r\n\r\n```bash\r\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\r\n```\r\n\r\n**CRITICAL:**\r\n- API key required for all agent operations\r\n- Never commit API keys to version control\r\n- Use environment variables\r\n\r\n### 3. Basic Query\r\n\r\n```typescript\r\nimport { query } from \"@anthropic-ai/claude-agent-sdk\";\r\n\r\nconst response = query({\r\n  prompt: \"Analyze the codebase and suggest improvements\",\r\n  options: {\r\n    model: \"claude-sonnet-4-5\",\r\n    workingDirectory: process.cwd(),\r\n    allowedTools: [\"Read\", \"Grep\", \"Glob\"]\r\n  }\r\n});\r\n\r\nfor await (const message of response) {\r\n  if (message.type === 'assistant') {\r\n    console.log(message.content);\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Critical Rules": "### Always Do\r\n\r\n✅ Install Claude Code CLI before using SDK\r\n✅ Set `ANTHROPIC_API_KEY` environment variable\r\n✅ Capture `session_id` from `system` messages for resuming\r\n✅ Use `allowedTools` to restrict agent capabilities\r\n✅ Implement `canUseTool` for custom permission logic\r\n✅ Handle all message types in streaming loop\r\n✅ Use Zod schemas for tool input validation\r\n✅ Set `workingDirectory` for multi-project environments\r\n✅ Test MCP servers in isolation before integration\r\n✅ Use `settingSources: [\"project\"]` in CI/CD\r\n✅ Monitor tool execution with `tool_call` messages\r\n✅ Implement error handling for all queries\r\n\r\n### Never Do\r\n\r\n❌ Commit API keys to version control\r\n❌ Use `bypassPermissions` in production (unless sandboxed)\r\n❌ Assume tools executed (check `tool_result` messages)\r\n❌ Ignore error messages in stream\r\n❌ Skip session ID capture if planning to resume\r\n❌ Use duplicate tool names across MCP servers\r\n❌ Allow unrestricted Bash access without `canUseTool`\r\n❌ Load settings from user in CI/CD (`settingSources: [\"user\"]`)\r\n❌ Trust tool results without validation\r\n❌ Hardcode file paths (use `workingDirectory`)\r\n❌ Use `acceptEdits` mode with untrusted prompts\r\n❌ Skip Zod validation for tool inputs\r\n\r\n---",
    "Known Issues Prevention": "This skill prevents **12** documented issues:\r\n\r\n### Issue #1: CLI Not Found Error\r\n**Error**: `\"Claude Code CLI not installed\"`\r\n**Source**: SDK requires Claude Code CLI\r\n**Why It Happens**: CLI not installed globally\r\n**Prevention**: Install before using SDK: `npm install -g @anthropic-ai/claude-code`\r\n\r\n### Issue #2: Authentication Failed\r\n**Error**: `\"Invalid API key\"`\r\n**Source**: Missing or incorrect ANTHROPIC_API_KEY\r\n**Why It Happens**: Environment variable not set\r\n**Prevention**: Always set `export ANTHROPIC_API_KEY=\"sk-ant-...\"`\r\n\r\n### Issue #3: Permission Denied Errors\r\n**Error**: Tool execution blocked\r\n**Source**: `permissionMode` restrictions\r\n**Why It Happens**: Tool not allowed by permissions\r\n**Prevention**: Use `allowedTools` or custom `canUseTool` callback\r\n\r\n### Issue #4: Context Length Exceeded\r\n**Error**: `\"Prompt too long\"`\r\n**Source**: Input exceeds model context window\r\n**Why It Happens**: Large codebase, long conversations\r\n**Prevention**: SDK auto-compacts, but reduce context if needed\r\n\r\n### Issue #5: Tool Execution Timeout\r\n**Error**: Tool doesn't respond\r\n**Source**: Long-running tool execution\r\n**Why It Happens**: Tool takes too long (>5 minutes default)\r\n**Prevention**: Implement timeout handling in tool implementations\r\n\r\n### Issue #6: Session Not Found\r\n**Error**: `\"Invalid session ID\"`\r\n**Source**: Session expired or invalid\r\n**Why It Happens**: Session ID incorrect or too old\r\n**Prevention**: Capture `session_id` from `system` init message\r\n\r\n### Issue #7: MCP Server Connection Failed\r\n**Error**: Server not responding\r\n**Source**: Server not running or misconfigured\r\n**Why It Happens**: Command/URL incorrect, server crashed\r\n**Prevention**: Test MCP server independently, verify command/URL\r\n\r\n### Issue #8: Subagent Definition Errors\r\n**Error**: Invalid AgentDefinition\r\n**Source**: Missing required fields\r\n**Why It Happens**: `description` or `prompt` missing\r\n**Prevention**: Always include `description` and `prompt` fields\r\n\r\n### Issue #9: Settings File Not Found\r\n**Error**: `\"Cannot read settings\"`\r\n**Source**: Settings file doesn't exist\r\n**Why It Happens**: `settingSources` includes non-existent file\r\n**Prevention**: Check file exists before including in sources\r\n\r\n### Issue #10: Tool Name Collision\r\n**Error**: Duplicate tool name\r\n**Source**: Multiple tools with same name\r\n**Why It Happens**: Two MCP servers define same tool name\r\n**Prevention**: Use unique tool names, prefix with server name\r\n\r\n### Issue #11: Zod Schema Validation Error\r\n**Error**: Invalid tool input\r\n**Source**: Input doesn't match Zod schema\r\n**Why It Happens**: Agent provided wrong data type\r\n**Prevention**: Use descriptive Zod schemas with `.describe()`\r\n\r\n### Issue #12: Filesystem Permission Denied\r\n**Error**: Cannot access path\r\n**Source**: Restricted filesystem access\r\n**Why It Happens**: Path outside `workingDirectory` or no permissions\r\n**Prevention**: Set correct `workingDirectory`, check file permissions\r\n\r\n---",
    "Dependencies": "**Required**:\r\n- `@anthropic-ai/claude-agent-sdk@0.1.0+` - Agent SDK\r\n- `zod@3.23.0+` - Schema validation\r\n\r\n**Optional**:\r\n- `@types/node@20.0.0+` - TypeScript types\r\n- `@modelcontextprotocol/sdk@latest` - MCP server development\r\n\r\n**System Requirements**:\r\n- Node.js 18.0.0+\r\n- Claude Code CLI (install: `npm install -g @anthropic-ai/claude-code`)\r\n- Valid ANTHROPIC_API_KEY\r\n\r\n---",
    "Session Management": "### Overview\r\n\r\nSessions allow:\r\n- **Persistent conversations** - Resume where you left off\r\n- **Context preservation** - Agent remembers previous interactions\r\n- **Alternative paths** - Fork to explore different approaches\r\n\r\n### Starting a Session\r\n\r\n```typescript\r\nimport { query } from \"@anthropic-ai/claude-agent-sdk\";\r\n\r\nlet sessionId: string | undefined;\r\n\r\nconst response = query({\r\n  prompt: \"Build a REST API with user authentication\",\r\n  options: {\r\n    model: \"claude-sonnet-4-5\"\r\n  }\r\n});\r\n\r\nfor await (const message of response) {\r\n  if (message.type === 'system' && message.subtype === 'init') {\r\n    sessionId = message.session_id;\r\n    console.log(`Session started: ${sessionId}`);\r\n  } else if (message.type === 'assistant') {\r\n    console.log(message.content);\r\n  }\r\n}\r\n\r\n// Save sessionId for later use\r\n```\r\n\r\n### Resuming a Session\r\n\r\n```typescript\r\n// Continue the conversation\r\nconst resumed = query({\r\n  prompt: \"Now add rate limiting to the API endpoints\",\r\n  options: {\r\n    resume: sessionId,  // Resume previous session\r\n    model: \"claude-sonnet-4-5\"\r\n  }\r\n});\r\n\r\nfor await (const message of resumed) {\r\n  // Agent has full context from previous session\r\n  if (message.type === 'assistant') {\r\n    console.log(message.content);\r\n  }\r\n}\r\n```\r\n\r\n### Forking a Session\r\n\r\n```typescript\r\n// Explore alternative approach without modifying original\r\nconst forked = query({\r\n  prompt: \"Actually, let's redesign this as a GraphQL API instead\",\r\n  options: {\r\n    resume: sessionId,\r\n    forkSession: true,  // Creates new branch\r\n    model: \"claude-sonnet-4-5\"\r\n  }\r\n});\r\n\r\nfor await (const message of forked) {\r\n  // New conversation path\r\n  // Original session unchanged\r\n}\r\n```\r\n\r\n### Session Management Patterns\r\n\r\n**Pattern 1: Sequential Development**\r\n\r\n```typescript\r\n// Step 1: Initial implementation\r\nlet session = await startSession(\"Create user authentication system\");\r\n\r\n// Step 2: Add feature\r\nsession = await resumeSession(session, \"Add OAuth support\");\r\n\r\n// Step 3: Add tests\r\nsession = await resumeSession(session, \"Write integration tests\");\r\n\r\n// Step 4: Deploy\r\nsession = await resumeSession(session, \"Deploy to production\");\r\n```\r\n\r\n**Pattern 2: Exploration & Decision**\r\n\r\n```typescript\r\n// Start main conversation\r\nlet mainSession = await startSession(\"Design payment processing system\");\r\n\r\n// Explore option A\r\nlet optionA = await forkSession(mainSession, \"Use Stripe integration\");\r\n\r\n// Explore option B\r\nlet optionB = await forkSession(mainSession, \"Use PayPal integration\");\r\n\r\n// Choose winner and continue\r\nlet chosenSession = optionA;  // Decision made\r\nawait resumeSession(chosenSession, \"Implement the chosen approach\");\r\n```\r\n\r\n**Pattern 3: Multi-User Collaboration**\r\n\r\n```typescript\r\n// Developer A starts work\r\nlet sessionA = await startSession(\"Implement user profile page\");\r\n\r\n// Developer B forks for different feature\r\nlet sessionB = await forkSession(sessionA, \"Add avatar upload\");\r\n\r\n// Both can work independently\r\n// Sessions don't interfere\r\n```\r\n\r\n---",
    "Complete Setup Checklist": "- [ ] Node.js 18.0.0+ installed\r\n- [ ] Claude Code CLI installed (`npm install -g @anthropic-ai/claude-code`)\r\n- [ ] SDK installed (`npm install @anthropic-ai/claude-agent-sdk zod`)\r\n- [ ] ANTHROPIC_API_KEY environment variable set\r\n- [ ] workingDirectory set for project\r\n- [ ] allowedTools configured (or using default)\r\n- [ ] permissionMode chosen (default recommended)\r\n- [ ] Error handling implemented\r\n- [ ] Session management (if needed)\r\n- [ ] MCP servers configured (if using custom tools)\r\n- [ ] Subagents defined (if needed)\r\n\r\n---\r\n\r\n**Questions? Issues?**\r\n\r\n1. Check [references/query-api-reference.md](references/query-api-reference.md) for complete API details\r\n2. Review [references/mcp-servers-guide.md](references/mcp-servers-guide.md) for custom tools\r\n3. See [references/subagents-patterns.md](references/subagents-patterns.md) for orchestration\r\n4. Check [references/top-errors.md](references/top-errors.md) for common issues\r\n5. Consult official docs: https://docs.claude.com/en/api/agent-sdk/\r\n\r\n---\r\n\r\n**Token Efficiency**: ~65% savings vs manual Agent SDK integration (estimated)\r\n**Error Prevention**: 100% (all 12 documented issues prevented)\r\n**Development Time**: 30 minutes with skill vs 3-4 hours manual",
    "Filesystem Settings": "### Setting Sources\r\n\r\n```typescript\r\ntype SettingSource = 'user' | 'project' | 'local';\r\n```\r\n\r\n- **user**: `~/.claude/settings.json` (global user settings)\r\n- **project**: `.claude/settings.json` (team-shared, version controlled)\r\n- **local**: `.claude/settings.local.json` (local overrides, gitignored)\r\n\r\n### Default Behavior\r\n\r\n```typescript\r\n// By default, NO filesystem settings loaded (isolated)\r\nconst response = query({\r\n  prompt: \"Review code\",\r\n  options: {\r\n    // settingSources: [] is default (no files loaded)\r\n  }\r\n});\r\n```\r\n\r\n### Load All Settings\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Build feature with project conventions\",\r\n  options: {\r\n    settingSources: [\"user\", \"project\", \"local\"]\r\n    // Loads all settings files\r\n    // Priority (highest first):\r\n    // 1. local (overrides everything)\r\n    // 2. project (team settings)\r\n    // 3. user (global defaults)\r\n  }\r\n});\r\n```\r\n\r\n### Load Project Settings Only\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Run CI checks\",\r\n  options: {\r\n    settingSources: [\"project\"]\r\n    // Only .claude/settings.json\r\n    // Useful for CI/CD (consistent behavior)\r\n    // Ignores user and local settings\r\n  }\r\n});\r\n```\r\n\r\n### Load CLAUDE.md\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Implement feature according to project guidelines\",\r\n  options: {\r\n    settingSources: [\"project\"],  // Reads CLAUDE.md from project\r\n    systemPrompt: {\r\n      type: 'preset',\r\n      preset: 'claude_code'         // Required to use CLAUDE.md\r\n    }\r\n  }\r\n});\r\n```\r\n\r\n### Settings Priority\r\n\r\nWhen multiple sources loaded, settings merge in this order (highest priority first):\r\n\r\n1. **Programmatic options** (passed to `query()`) - Always win\r\n2. **Local settings** (`.claude/settings.local.json`)\r\n3. **Project settings** (`.claude/settings.json`)\r\n4. **User settings** (`~/.claude/settings.json`)\r\n\r\n**Example:**\r\n\r\n```typescript\r\n// .claude/settings.json\r\n{\r\n  \"allowedTools\": [\"Read\", \"Write\", \"Edit\"]\r\n}\r\n\r\n// .claude/settings.local.json\r\n{\r\n  \"allowedTools\": [\"Read\"]  // Overrides project settings\r\n}\r\n\r\n// Programmatic\r\nconst response = query({\r\n  options: {\r\n    settingSources: [\"project\", \"local\"],\r\n    allowedTools: [\"Read\", \"Grep\"]  // ← This wins\r\n  }\r\n});\r\n\r\n// Actual allowedTools: [\"Read\", \"Grep\"]\r\n```\r\n\r\n### Use Cases\r\n\r\n**CI/CD Environments:**\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Run automated tests\",\r\n  options: {\r\n    settingSources: [\"project\"],      // Only team-shared settings\r\n    permissionMode: \"bypassPermissions\"  // No interactive prompts\r\n  }\r\n});\r\n```\r\n\r\n**SDK-Only Applications:**\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Analyze code snippet\",\r\n  options: {\r\n    settingSources: [],               // No filesystem dependencies\r\n    workingDirectory: \"/tmp/sandbox\",\r\n    allowedTools: [\"Read\", \"Grep\"],\r\n    systemPrompt: \"You are a code analyzer.\"\r\n  }\r\n});\r\n```\r\n\r\n**Hybrid Approach:**\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Implement authentication\",\r\n  options: {\r\n    settingSources: [\"project\"],      // Load CLAUDE.md and settings\r\n    systemPrompt: \"Follow security best practices.\",\r\n    agents: {                         // Add programmatic agents\r\n      \"security-checker\": { /* ... */ }\r\n    }\r\n  }\r\n});\r\n```\r\n\r\n---",
    "Error Handling": "### SDK Errors\r\n\r\n```typescript\r\nimport { query } from \"@anthropic-ai/claude-agent-sdk\";\r\n\r\ntry {\r\n  const response = query({\r\n    prompt: \"Analyze code\",\r\n    options: { model: \"sonnet\" }\r\n  });\r\n\r\n  for await (const message of response) {\r\n    // Process messages\r\n  }\r\n} catch (error) {\r\n  // Handle SDK errors\r\n  if (error.code === 'AUTHENTICATION_FAILED') {\r\n    console.error('Invalid API key');\r\n  } else if (error.code === 'RATE_LIMIT_EXCEEDED') {\r\n    console.error('Rate limit exceeded, retry after delay');\r\n  } else if (error.code === 'CONTEXT_LENGTH_EXCEEDED') {\r\n    console.error('Context too large, use session compaction');\r\n  } else if (error.code === 'CLI_NOT_FOUND') {\r\n    console.error('Claude Code CLI not installed');\r\n  }\r\n}\r\n```\r\n\r\n### Common Error Codes\r\n\r\n| Error Code | Cause | Solution |\r\n|------------|-------|----------|\r\n| `CLI_NOT_FOUND` | Claude Code not installed | Install: `npm install -g @anthropic-ai/claude-code` |\r\n| `AUTHENTICATION_FAILED` | Invalid API key | Check ANTHROPIC_API_KEY env var |\r\n| `RATE_LIMIT_EXCEEDED` | Too many requests | Implement retry with backoff |\r\n| `CONTEXT_LENGTH_EXCEEDED` | Prompt too long | Use session compaction, reduce context |\r\n| `PERMISSION_DENIED` | Tool blocked | Check permissionMode, canUseTool |\r\n| `TOOL_EXECUTION_FAILED` | Tool error | Check tool implementation |\r\n| `SESSION_NOT_FOUND` | Invalid session ID | Verify session ID |\r\n| `MCP_SERVER_FAILED` | Server error | Check server configuration |\r\n\r\n### Error Handling Pattern\r\n\r\n```typescript\r\nasync function safeAgentExecution(prompt: string) {\r\n  try {\r\n    const response = query({\r\n      prompt,\r\n      options: {\r\n        model: \"sonnet\",\r\n        permissionMode: \"default\"\r\n      }\r\n    });\r\n\r\n    const results: string[] = [];\r\n\r\n    for await (const message of response) {\r\n      if (message.type === 'assistant') {\r\n        results.push(message.content);\r\n      } else if (message.type === 'error') {\r\n        console.warn('Agent error:', message.error);\r\n        if (message.error.type === 'permission_denied') {\r\n          // Handle permission errors gracefully\r\n          console.log('Skipping restricted operation');\r\n        }\r\n      }\r\n    }\r\n\r\n    return results;\r\n  } catch (error) {\r\n    console.error('Fatal error:', error);\r\n\r\n    // Specific error handling\r\n    if (error.code === 'CLI_NOT_FOUND') {\r\n      throw new Error('Please install Claude Code CLI first');\r\n    } else if (error.code === 'AUTHENTICATION_FAILED') {\r\n      throw new Error('Invalid API key. Check ANTHROPIC_API_KEY');\r\n    } else if (error.code === 'RATE_LIMIT_EXCEEDED') {\r\n      // Retry with exponential backoff\r\n      await delay(5000);\r\n      return safeAgentExecution(prompt);  // Retry\r\n    } else {\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n---",
    "The Complete Claude Agent SDK Reference": "",
    "Core Query API": "### The `query()` Function\r\n\r\nThe primary interface for interacting with Claude Code CLI programmatically.\r\n\r\n```typescript\r\nimport { query } from \"@anthropic-ai/claude-agent-sdk\";\r\n\r\nconst response = query({\r\n  prompt: string | AsyncIterable<SDKUserMessage>,\r\n  options?: Options\r\n});\r\n\r\n// Response is AsyncGenerator<SDKMessage, void>\r\nfor await (const message of response) {\r\n  // Process streaming messages\r\n}\r\n```\r\n\r\n### Basic Options\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Review this code for bugs\",\r\n  options: {\r\n    model: \"claude-sonnet-4-5\",        // or \"haiku\", \"opus\"\r\n    workingDirectory: \"/path/to/project\",\r\n    systemPrompt: \"You are a security-focused code reviewer.\",\r\n    allowedTools: [\"Read\", \"Grep\", \"Glob\"],\r\n    disallowedTools: [\"Write\", \"Edit\", \"Bash\"],\r\n    permissionMode: \"default\"           // or \"acceptEdits\", \"bypassPermissions\"\r\n  }\r\n});\r\n```\r\n\r\n### Model Selection\r\n\r\n| Model | ID | Best For | Speed | Capability |\r\n|-------|-----|----------|-------|------------|\r\n| **Haiku** | `\"haiku\"` | Fast tasks, monitoring | Fastest | Basic |\r\n| **Sonnet** | `\"sonnet\"` or `\"claude-sonnet-4-5\"` | Balanced | Medium | High |\r\n| **Opus** | `\"opus\"` | Complex reasoning | Slowest | Highest |\r\n| **Inherit** | `\"inherit\"` | Use parent model | - | - |\r\n\r\n**Default**: `\"sonnet\"` if not specified\r\n\r\n### System Prompts\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Implement user authentication\",\r\n  options: {\r\n    systemPrompt: `You are an expert backend developer.\r\n\r\nFollow these principles:\r\n- Always use TypeScript with strict types\r\n- Implement comprehensive error handling\r\n- Add detailed logging for debugging\r\n- Write unit tests for all functions\r\n- Follow OWASP security guidelines`\r\n  }\r\n});\r\n```\r\n\r\n**CRITICAL:**\r\n- System prompt sets agent behavior for entire session\r\n- Should be clear and specific\r\n- Can be 1-10k tokens (affects context window)\r\n\r\n### Working Directory\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Refactor the user service\",\r\n  options: {\r\n    workingDirectory: \"/Users/dev/projects/my-app\",\r\n    // Agent operates within this directory\r\n    // Relative paths resolved from here\r\n  }\r\n});\r\n```\r\n\r\n**Best Practices:**\r\n- Use absolute paths for clarity\r\n- Agent stays within this directory scope\r\n- Critical for multi-project environments\r\n\r\n---",
    "MCP Servers (Model Context Protocol)": "### Overview\r\n\r\nMCP servers extend agent capabilities with custom tools. The SDK supports:\r\n- **In-process servers** (`createSdkMcpServer`) - Run in same process\r\n- **External servers** (stdio, HTTP, SSE) - Separate processes\r\n\r\n### Creating In-Process MCP Servers\r\n\r\n```typescript\r\nimport { createSdkMcpServer, tool } from \"@anthropic-ai/claude-agent-sdk\";\r\nimport { z } from \"zod\";\r\n\r\nconst weatherServer = createSdkMcpServer({\r\n  name: \"weather-service\",\r\n  version: \"1.0.0\",\r\n  tools: [\r\n    tool(\r\n      \"get_weather\",\r\n      \"Get current weather for a location\",\r\n      {\r\n        location: z.string().describe(\"City name or coordinates\"),\r\n        units: z.enum([\"celsius\", \"fahrenheit\"]).default(\"celsius\")\r\n      },\r\n      async (args) => {\r\n        // Tool implementation\r\n        const response = await fetch(\r\n          `https://api.weather.com/v1/current?location=${args.location}&units=${args.units}`\r\n        );\r\n        const data = await response.json();\r\n\r\n        return {\r\n          content: [{\r\n            type: \"text\",\r\n            text: `Temperature: ${data.temp}° ${args.units}\r\nConditions: ${data.conditions}\r\nHumidity: ${data.humidity}%`\r\n          }]\r\n        };\r\n      }\r\n    )\r\n  ]\r\n});\r\n\r\n// Use in query\r\nconst response = query({\r\n  prompt: \"What's the weather in San Francisco?\",\r\n  options: {\r\n    mcpServers: {\r\n      \"weather-service\": weatherServer\r\n    },\r\n    allowedTools: [\"mcp__weather-service__get_weather\"]\r\n  }\r\n});\r\n```\r\n\r\n### Tool Definition Pattern\r\n\r\n```typescript\r\ntool(\r\n  name: string,                    // Tool identifier\r\n  description: string,             // What the tool does\r\n  inputSchema: ZodSchema,          // Input validation\r\n  handler: async (args) => Result // Implementation\r\n)\r\n```\r\n\r\n**Input Schema Options:**\r\n\r\n```typescript\r\n// Simple object schema\r\n{\r\n  email: z.string().email(),\r\n  limit: z.number().min(1).max(100).default(10),\r\n  enabled: z.boolean().optional()\r\n}\r\n\r\n// Complex nested schema\r\n{\r\n  user: z.object({\r\n    name: z.string(),\r\n    age: z.number().min(0)\r\n  }),\r\n  filters: z.array(z.string()).optional()\r\n}\r\n\r\n// Enum types\r\n{\r\n  status: z.enum([\"pending\", \"active\", \"completed\"]),\r\n  priority: z.union([z.literal(\"low\"), z.literal(\"high\")])\r\n}\r\n```\r\n\r\n**Handler Return Format:**\r\n\r\n```typescript\r\n// Success\r\nreturn {\r\n  content: [{\r\n    type: \"text\",\r\n    text: \"Result data here\"\r\n  }]\r\n};\r\n\r\n// Error\r\nreturn {\r\n  content: [{\r\n    type: \"text\",\r\n    text: \"Error description\"\r\n  }],\r\n  isError: true\r\n};\r\n```\r\n\r\n### Multiple Tools in One Server\r\n\r\n```typescript\r\nconst databaseServer = createSdkMcpServer({\r\n  name: \"database\",\r\n  version: \"1.0.0\",\r\n  tools: [\r\n    tool(\r\n      \"query_users\",\r\n      \"Query user records from database\",\r\n      {\r\n        email: z.string().email().optional(),\r\n        limit: z.number().min(1).max(100).default(10)\r\n      },\r\n      async (args) => {\r\n        const results = await db.query(\"SELECT * FROM users WHERE...\");\r\n        return {\r\n          content: [{ type: \"text\", text: JSON.stringify(results, null, 2) }]\r\n        };\r\n      }\r\n    ),\r\n    tool(\r\n      \"create_user\",\r\n      \"Create a new user record\",\r\n      {\r\n        email: z.string().email(),\r\n        name: z.string(),\r\n        role: z.enum([\"admin\", \"user\", \"guest\"])\r\n      },\r\n      async (args) => {\r\n        const user = await db.insert(\"users\", args);\r\n        return {\r\n          content: [{ type: \"text\", text: `User created: ${user.id}` }]\r\n        };\r\n      }\r\n    ),\r\n    tool(\r\n      \"delete_user\",\r\n      \"Delete a user by ID\",\r\n      { userId: z.string().uuid() },\r\n      async (args) => {\r\n        await db.delete(\"users\", args.userId);\r\n        return {\r\n          content: [{ type: \"text\", text: \"User deleted\" }]\r\n        };\r\n      }\r\n    )\r\n  ]\r\n});\r\n```\r\n\r\n### External MCP Servers (stdio)\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"List files and analyze Git history\",\r\n  options: {\r\n    mcpServers: {\r\n      // Filesystem server\r\n      \"filesystem\": {\r\n        command: \"npx\",\r\n        args: [\"@modelcontextprotocol/server-filesystem\"],\r\n        env: {\r\n          ALLOWED_PATHS: \"/Users/developer/projects:/tmp\"\r\n        }\r\n      },\r\n      // Git operations server\r\n      \"git\": {\r\n        command: \"npx\",\r\n        args: [\"@modelcontextprotocol/server-git\"],\r\n        env: {\r\n          GIT_REPO_PATH: \"/Users/developer/projects/my-repo\"\r\n        }\r\n      }\r\n    },\r\n    allowedTools: [\r\n      \"mcp__filesystem__list_files\",\r\n      \"mcp__filesystem__read_file\",\r\n      \"mcp__git__log\",\r\n      \"mcp__git__diff\"\r\n    ]\r\n  }\r\n});\r\n```\r\n\r\n### External MCP Servers (HTTP/SSE)\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Analyze data from remote service\",\r\n  options: {\r\n    mcpServers: {\r\n      \"remote-service\": {\r\n        url: \"https://api.example.com/mcp\",\r\n        headers: {\r\n          \"Authorization\": \"Bearer your-token-here\",\r\n          \"Content-Type\": \"application/json\"\r\n        }\r\n      }\r\n    },\r\n    allowedTools: [\"mcp__remote-service__analyze\"]\r\n  }\r\n});\r\n```\r\n\r\n### MCP Tool Naming Convention\r\n\r\n**Format**: `mcp__<server-name>__<tool-name>`\r\n\r\nExamples:\r\n- `mcp__weather-service__get_weather`\r\n- `mcp__database__query_users`\r\n- `mcp__filesystem__read_file`\r\n- `mcp__git__log`\r\n\r\n**CRITICAL:**\r\n- Server name and tool name MUST match configuration\r\n- Use double underscores (`__`) as separators\r\n- Include in `allowedTools` array\r\n\r\n---",
    "Subagent Orchestration": "### What Are Subagents?\r\n\r\nSpecialized agents with:\r\n- **Specific expertise** - Focused on one domain\r\n- **Custom tools** - Only tools they need\r\n- **Different models** - Match capability to task\r\n- **Dedicated prompts** - Tailored instructions\r\n\r\n### Defining Subagents\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Deploy the application to production\",\r\n  options: {\r\n    model: \"claude-sonnet-4-5\",\r\n    agents: {\r\n      \"test-runner\": {\r\n        description: \"Run test suites and verify coverage\",\r\n        prompt: \"You run tests. Always verify 100% pass before approving deployment. Report failures clearly.\",\r\n        tools: [\"Bash\", \"Read\", \"Grep\"],\r\n        model: \"haiku\"  // Fast, cost-effective for testing\r\n      },\r\n      \"security-checker\": {\r\n        description: \"Security validation and vulnerability scanning\",\r\n        prompt: \"You check security. Verify no secrets committed, dependencies updated, OWASP compliance.\",\r\n        tools: [\"Read\", \"Grep\", \"Bash\"],\r\n        model: \"sonnet\"  // Balance for security analysis\r\n      },\r\n      \"deployer\": {\r\n        description: \"Handle deployments and rollbacks\",\r\n        prompt: \"You deploy. Deploy to staging first, verify health checks, then production. Always have rollback plan.\",\r\n        tools: [\"Bash\", \"Read\"],\r\n        model: \"sonnet\"  // Reliable for critical operations\r\n      }\r\n    }\r\n  }\r\n});\r\n```\r\n\r\n### AgentDefinition Type\r\n\r\n```typescript\r\ntype AgentDefinition = {\r\n  description: string;        // When to use this agent\r\n  prompt: string;             // System prompt for agent\r\n  tools?: string[];           // Allowed tools (optional)\r\n  model?: 'sonnet' | 'opus' | 'haiku' | 'inherit';  // Model (optional)\r\n}\r\n```\r\n\r\n**Field Details:**\r\n\r\n- **description**: Natural language description of when to use agent\r\n  - Used by main agent to decide which subagent to invoke\r\n  - Should be clear and specific\r\n  - Examples: \"Handle database queries\", \"Deploy to production\"\r\n\r\n- **prompt**: System prompt for the subagent\r\n  - Defines agent's role and behavior\r\n  - Can include instructions, constraints, formatting\r\n  - Inherits main agent's context\r\n\r\n- **tools**: Array of allowed tool names\r\n  - If omitted, inherits all tools from main agent\r\n  - Use to restrict agent to specific tools\r\n  - Examples: `[\"Read\", \"Grep\"]` for read-only agent\r\n\r\n- **model**: Model override\r\n  - `\"haiku\"` - Fast, cost-effective tasks\r\n  - `\"sonnet\"` - Balanced capability\r\n  - `\"opus\"` - Maximum reasoning\r\n  - `\"inherit\"` - Use main agent's model\r\n  - If omitted, inherits main agent's model\r\n\r\n### Multi-Agent Workflow Example\r\n\r\n```typescript\r\nasync function runDevOpsAgent(task: string) {\r\n  const response = query({\r\n    prompt: task,\r\n    options: {\r\n      model: \"claude-sonnet-4-5\",\r\n      workingDirectory: process.cwd(),\r\n      systemPrompt: `You are a DevOps orchestrator.\r\nCoordinate specialized agents to:\r\n- Run tests (test-runner agent)\r\n- Check security (security-checker agent)\r\n- Deploy application (deployer agent)\r\n- Monitor systems (monitoring-agent agent)`,\r\n\r\n      agents: {\r\n        \"test-runner\": {\r\n          description: \"Run automated test suites\",\r\n          prompt: \"You run tests. Execute test commands, parse results, report coverage. Fail if any tests fail.\",\r\n          tools: [\"Bash\", \"Read\"],\r\n          model: \"haiku\"\r\n        },\r\n        \"security-checker\": {\r\n          description: \"Security audits and vulnerability scanning\",\r\n          prompt: \"You check security. Scan for secrets, check dependencies, validate permissions, verify OWASP compliance.\",\r\n          tools: [\"Read\", \"Grep\", \"Bash\"],\r\n          model: \"sonnet\"\r\n        },\r\n        \"deployer\": {\r\n          description: \"Application deployment and rollbacks\",\r\n          prompt: \"You deploy. Deploy to staging, verify health checks, deploy to production, have rollback ready.\",\r\n          tools: [\"Bash\", \"Read\"],\r\n          model: \"sonnet\"\r\n        },\r\n        \"monitoring-agent\": {\r\n          description: \"System monitoring and alerting\",\r\n          prompt: \"You monitor. Check metrics, detect anomalies, alert on issues, track SLAs.\",\r\n          tools: [\"Bash\", \"Read\"],\r\n          model: \"haiku\"\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  for await (const message of response) {\r\n    if (message.type === 'assistant') {\r\n      console.log('Orchestrator:', message.content);\r\n    }\r\n  }\r\n}\r\n\r\n// Usage\r\nawait runDevOpsAgent(\"Deploy version 2.5.0 to production with full validation\");\r\n```\r\n\r\n### When to Use Subagents\r\n\r\n✅ **Use subagents when:**\r\n- Task requires different expertise areas\r\n- Some subtasks need different models (cost optimization)\r\n- Tool access should be restricted per role\r\n- Clear separation of concerns needed\r\n- Multiple steps with specialized knowledge\r\n\r\n❌ **Don't use subagents when:**\r\n- Single straightforward task\r\n- All work can be done by one agent\r\n- Overhead of orchestration > benefit\r\n- Tools/permissions don't vary\r\n\r\n---",
    "Package Versions (Verified 2025-10-25)": "```json\r\n{\r\n  \"dependencies\": {\r\n    \"@anthropic-ai/claude-agent-sdk\": \"^0.1.0\",\r\n    \"zod\": \"^3.23.0\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@types/node\": \"^20.0.0\",\r\n    \"typescript\": \"^5.3.0\"\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Message Types & Streaming": "### Message Types\r\n\r\n```typescript\r\ntype SDKMessage =\r\n  | SystemMessage\r\n  | AssistantMessage\r\n  | ToolCallMessage\r\n  | ToolResultMessage\r\n  | ErrorMessage;\r\n```\r\n\r\n### System Messages\r\n\r\n```typescript\r\ntype SystemMessage = {\r\n  type: 'system';\r\n  subtype: 'init' | 'completion';\r\n  uuid: string;\r\n  session_id: string;\r\n  apiKeySource?: 'user' | 'project' | 'org' | 'temporary';\r\n  cwd?: string;\r\n  tools?: string[];\r\n  mcp_servers?: { name: string; status: string }[];\r\n  model?: string;\r\n  permissionMode?: string;\r\n  slash_commands?: string[];\r\n  output_style?: string;\r\n};\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nfor await (const message of response) {\r\n  if (message.type === 'system') {\r\n    if (message.subtype === 'init') {\r\n      console.log(`Session ID: ${message.session_id}`);\r\n      console.log(`Model: ${message.model}`);\r\n      console.log(`Available tools: ${message.tools.join(', ')}`);\r\n    } else if (message.subtype === 'completion') {\r\n      console.log('Task completed');\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Assistant Messages\r\n\r\n```typescript\r\ntype AssistantMessage = {\r\n  type: 'assistant';\r\n  content: string | ContentBlock[];\r\n  model?: string;\r\n};\r\n\r\ntype ContentBlock =\r\n  | { type: 'text'; text: string }\r\n  | { type: 'tool_use'; id: string; name: string; input: any };\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nfor await (const message of response) {\r\n  if (message.type === 'assistant') {\r\n    if (typeof message.content === 'string') {\r\n      console.log('Assistant:', message.content);\r\n    } else {\r\n      message.content.forEach(block => {\r\n        if (block.type === 'text') {\r\n          console.log('Text:', block.text);\r\n        } else if (block.type === 'tool_use') {\r\n          console.log(`Tool request: ${block.name}`, block.input);\r\n        }\r\n      });\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Tool Call Messages\r\n\r\n```typescript\r\ntype ToolCallMessage = {\r\n  type: 'tool_call';\r\n  tool_name: string;\r\n  input: any;\r\n};\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nfor await (const message of response) {\r\n  if (message.type === 'tool_call') {\r\n    console.log(`Executing tool: ${message.tool_name}`);\r\n    console.log(`Input:`, JSON.stringify(message.input, null, 2));\r\n  }\r\n}\r\n```\r\n\r\n### Tool Result Messages\r\n\r\n```typescript\r\ntype ToolResultMessage = {\r\n  type: 'tool_result';\r\n  tool_name: string;\r\n  result: any;\r\n};\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nfor await (const message of response) {\r\n  if (message.type === 'tool_result') {\r\n    console.log(`Tool ${message.tool_name} completed`);\r\n    console.log(`Result:`, message.result);\r\n  }\r\n}\r\n```\r\n\r\n### Error Messages\r\n\r\n```typescript\r\ntype ErrorMessage = {\r\n  type: 'error';\r\n  error: {\r\n    type: string;\r\n    message: string;\r\n    tool?: string;\r\n  };\r\n};\r\n```\r\n\r\n**Usage:**\r\n\r\n```typescript\r\nfor await (const message of response) {\r\n  if (message.type === 'error') {\r\n    console.error('Error:', message.error.message);\r\n    if (message.error.type === 'permission_denied') {\r\n      console.log('Permission was denied for:', message.error.tool);\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Complete Message Processing\r\n\r\n```typescript\r\nasync function processAgent(prompt: string) {\r\n  const response = query({ prompt, options: { model: \"sonnet\" } });\r\n\r\n  try {\r\n    for await (const message of response) {\r\n      switch (message.type) {\r\n        case 'system':\r\n          if (message.subtype === 'init') {\r\n            console.log(`Session: ${message.session_id}`);\r\n          }\r\n          break;\r\n\r\n        case 'assistant':\r\n          if (typeof message.content === 'string') {\r\n            console.log('Assistant:', message.content);\r\n          }\r\n          break;\r\n\r\n        case 'tool_call':\r\n          console.log(`Executing: ${message.tool_name}`);\r\n          break;\r\n\r\n        case 'tool_result':\r\n          console.log(`Completed: ${message.tool_name}`);\r\n          break;\r\n\r\n        case 'error':\r\n          console.error('Error:', message.error.message);\r\n          break;\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Fatal error:', error);\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Official Documentation": "- **Agent SDK Overview**: https://docs.claude.com/en/api/agent-sdk/overview\r\n- **TypeScript API**: https://docs.claude.com/en/api/agent-sdk/typescript\r\n- **Python API**: https://docs.claude.com/en/api/agent-sdk/python\r\n- **Model Context Protocol**: https://modelcontextprotocol.io/\r\n- **GitHub (TypeScript)**: https://github.com/anthropics/claude-agent-sdk-typescript\r\n- **GitHub (Python)**: https://github.com/anthropics/claude-agent-sdk-python\r\n- **Context7 Library ID**: /anthropics/claude-agent-sdk-typescript\r\n\r\n---",
    "Troubleshooting": "### Problem: CLI not found error\r\n**Solution**: Install Claude Code CLI: `npm install -g @anthropic-ai/claude-code`\r\n\r\n### Problem: Permission denied on tool execution\r\n**Solution**: Check `allowedTools`, implement custom `canUseTool`, or use `permissionMode: \"acceptEdits\"`\r\n\r\n### Problem: MCP server not connecting\r\n**Solution**: Verify command/URL, test server independently, check logs\r\n\r\n### Problem: Context length exceeded\r\n**Solution**: SDK auto-compacts, but consider shorter prompts, session forking, or reducing allowed tools\r\n\r\n### Problem: Session not found\r\n**Solution**: Verify `session_id` captured from system init message, check session hasn't expired\r\n\r\n### Problem: Tool name collision\r\n**Solution**: Use unique tool names, prefix with server name if needed\r\n\r\n**Full Error Reference**: [references/top-errors.md](references/top-errors.md)\r\n\r\n---",
    "Tool Integration (Built-in + Custom)": "### Built-in Tools\r\n\r\nThe SDK provides access to Claude Code's built-in tools:\r\n\r\n| Tool | Description | Use Case |\r\n|------|-------------|----------|\r\n| `Read` | Read file contents | Code analysis |\r\n| `Write` | Create new files | Generate code |\r\n| `Edit` | Modify existing files | Refactoring |\r\n| `Bash` | Execute shell commands | Run tests, git |\r\n| `Grep` | Search file contents | Find patterns |\r\n| `Glob` | Find files by pattern | File discovery |\r\n| `WebSearch` | Search the web | Research |\r\n| `WebFetch` | Fetch URL content | Documentation |\r\n| `Task` | Delegate to subagent | Orchestration |\r\n\r\n### Allowing/Disallowing Tools\r\n\r\n```typescript\r\n// Whitelist approach (recommended)\r\nconst response = query({\r\n  prompt: \"Analyze code but don't modify anything\",\r\n  options: {\r\n    allowedTools: [\"Read\", \"Grep\", \"Glob\"]\r\n    // ONLY these tools can be used\r\n  }\r\n});\r\n\r\n// Blacklist approach\r\nconst response = query({\r\n  prompt: \"Review and fix issues\",\r\n  options: {\r\n    disallowedTools: [\"Bash\"]\r\n    // Everything except Bash allowed\r\n  }\r\n});\r\n\r\n// Combination (allowedTools takes precedence)\r\nconst response = query({\r\n  prompt: \"Safe code review\",\r\n  options: {\r\n    allowedTools: [\"Read\", \"Grep\", \"Glob\", \"Edit\"],\r\n    disallowedTools: [\"Edit\"]  // Edit still blocked (allowedTools overridden)\r\n  }\r\n});\r\n```\r\n\r\n**CRITICAL:**\r\n- `allowedTools` = whitelist (only these tools)\r\n- `disallowedTools` = blacklist (everything except these)\r\n- If both specified, `allowedTools` wins\r\n\r\n### Custom Tool Execution Monitoring\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Implement feature X\",\r\n  options: {\r\n    allowedTools: [\"Read\", \"Write\", \"Edit\", \"Bash\"]\r\n  }\r\n});\r\n\r\nfor await (const message of response) {\r\n  if (message.type === 'tool_call') {\r\n    console.log(`Tool requested: ${message.tool_name}`);\r\n    console.log(`Input:`, message.input);\r\n  } else if (message.type === 'tool_result') {\r\n    console.log(`Tool ${message.tool_name} completed`);\r\n  }\r\n}\r\n```\r\n\r\n---",
    "Permission Control": "### Permission Modes\r\n\r\n```typescript\r\ntype PermissionMode =\r\n  | \"default\"             // Standard permission checks\r\n  | \"acceptEdits\"         // Auto-approve file edits\r\n  | \"bypassPermissions\";  // Skip ALL checks (use with caution)\r\n```\r\n\r\n### Default Mode\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Analyze and modify code\",\r\n  options: {\r\n    permissionMode: \"default\"\r\n    // User prompted for:\r\n    // - File writes/edits\r\n    // - Potentially dangerous bash commands\r\n    // - Sensitive operations\r\n  }\r\n});\r\n```\r\n\r\n### Accept Edits Mode\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Refactor the user service to use async/await\",\r\n  options: {\r\n    permissionMode: \"acceptEdits\"\r\n    // Automatically approves:\r\n    // - File edits\r\n    // - File writes\r\n    // Still prompts for:\r\n    // - Dangerous bash commands\r\n    // - Sensitive operations\r\n  }\r\n});\r\n```\r\n\r\n### Bypass Permissions Mode\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Run comprehensive test suite and fix all failures\",\r\n  options: {\r\n    permissionMode: \"bypassPermissions\"\r\n    // ⚠️ CAUTION: Skips ALL permission checks\r\n    // Use only in:\r\n    // - Trusted environments\r\n    // - CI/CD pipelines\r\n    // - Sandboxed containers\r\n  }\r\n});\r\n```\r\n\r\n### Custom Permission Logic\r\n\r\n```typescript\r\nconst response = query({\r\n  prompt: \"Deploy application to production\",\r\n  options: {\r\n    permissionMode: \"default\",\r\n    canUseTool: async (toolName, input) => {\r\n      // Allow read-only operations\r\n      if (['Read', 'Grep', 'Glob'].includes(toolName)) {\r\n        return { behavior: \"allow\" };\r\n      }\r\n\r\n      // Deny destructive bash commands\r\n      if (toolName === 'Bash') {\r\n        const dangerous = ['rm -rf', 'dd if=', 'mkfs', '> /dev/'];\r\n        if (dangerous.some(pattern => input.command.includes(pattern))) {\r\n          return {\r\n            behavior: \"deny\",\r\n            message: \"Destructive command blocked for safety\"\r\n          };\r\n        }\r\n      }\r\n\r\n      // Require confirmation for deployments\r\n      if (input.command?.includes('deploy') || input.command?.includes('kubectl apply')) {\r\n        return {\r\n          behavior: \"ask\",\r\n          message: \"Confirm deployment to production?\"\r\n        };\r\n      }\r\n\r\n      // Allow by default\r\n      return { behavior: \"allow\" };\r\n    }\r\n  }\r\n});\r\n```\r\n\r\n### canUseTool Callback\r\n\r\n```typescript\r\ntype CanUseToolCallback = (\r\n  toolName: string,\r\n  input: any\r\n) => Promise<PermissionDecision>;\r\n\r\ntype PermissionDecision =\r\n  | { behavior: \"allow\" }\r\n  | { behavior: \"deny\"; message?: string }\r\n  | { behavior: \"ask\"; message?: string };\r\n```\r\n\r\n**Examples:**\r\n\r\n```typescript\r\n// Block all file writes\r\ncanUseTool: async (toolName, input) => {\r\n  if (toolName === 'Write' || toolName === 'Edit') {\r\n    return { behavior: \"deny\", message: \"No file modifications allowed\" };\r\n  }\r\n  return { behavior: \"allow\" };\r\n}\r\n\r\n// Require confirmation for specific files\r\ncanUseTool: async (toolName, input) => {\r\n  const sensitivePaths = ['/etc/', '/root/', '.env', 'credentials.json'];\r\n  if ((toolName === 'Write' || toolName === 'Edit') &&\r\n      sensitivePaths.some(path => input.file_path?.includes(path))) {\r\n    return {\r\n      behavior: \"ask\",\r\n      message: `Modify sensitive file ${input.file_path}?`\r\n    };\r\n  }\r\n  return { behavior: \"allow\" };\r\n}\r\n\r\n// Log all tool usage\r\ncanUseTool: async (toolName, input) => {\r\n  console.log(`Tool requested: ${toolName}`, input);\r\n  await logToDatabase(toolName, input);\r\n  return { behavior: \"allow\" };\r\n}\r\n```\r\n\r\n---"
  }
}